---
title: "Overall Analysis"
author: "Clinton"
date: "13 April 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
```


<br>

```
Objective: General Analysis
```


<br>

### 1. Set Up {.tabset .tabset-fade}

#### README

In general, the data sets are relatively large, and take up a large amount of memory after loading. It is recommended that after loading, that the data sets be subsetted or summarised, and unused data frames to be removed.

The code is shown in the next three tabs to show any changes that may have been made. In general, no columns or rows are removed. Filtering occured in the next step.

<br>

#### General

```{r message = FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
library(extrafont)
library(stringr)
loadfonts()
library(tidyr)
library(DT)
library(tidytext)
library(psych)
library(sf)
library(leaflet)
library(ggpubr)

# Theme setting for visualisations
theme_set(theme_minimal() + 
            theme(panel.grid.minor = element_blank(),
                  text = element_text(family = "Quicksand",
                                      colour = "black")))
options(scipen = 999)

# Source occ_modifier
source("0_OCC_Modifier.R")
source("0_Categories_Generator.R")

# Reference files
OCC_1880 = readr::read_csv("../Data/OCC1880.csv")
OCC_1950 = readr::read_csv("../Data/OCC1950.csv")
IND_1950 = readr::read_csv("../Data/IND1950.csv")
```

#### Loading 1850

```{r eval = FALSE}
# Loading
mn_1850 = readr::read_csv("../Data/census_1850_occ_mn.csv") %>% mutate(city = "Manhattan")
bk_1850 = readr::read_csv("../Data/census_1850_occ_bk.csv") %>% mutate(city = "Brooklyn")
combined = rbind(mn_1850, bk_1850)

# Saving Memory
rm(bk_1850)
rm(mn_1850)

# Combining Data
combined = combined %>% 
  left_join(OCC_1880, by = c("occ" = "code")) %>%
  left_join(OCC_1950, by = c("occ1950" = "code")) %>%
  left_join(IND_1950, by = "ind1950") %>%
  mutate(occ_cat_label = add_occ_cat_label(.),
         occ1950_cat_label = add_occ1950_cat_label(.),
         ind1950_cat_label = add_ind1950_cat_label(.),
         race = factor(race,
                       levels = c(100,120,200,210,300),
                       labels = c("White", "White",
                                  "Black/African American/Negro",
                                  "Mulatto", 
                                  "American Indian/Alaska Native (AIAN)")),
         sex = factor(sex,
                      levels = c(1,2),
                      labels = c("Male", "Female")),
         year = 1850,
         labforce = factor(labforce,
                           levels = c(0,1,2),
                           labels = c("N/A",
                                      "No, not in the labor force",
                                      "Yes, in the labor force"))) %>%
  
  select(year, age, sex, race, city, 
         enumdist, ward, labforce,
         occstr,
         occ, occ_label, occ_cat_label, 
         occ1950, occ1950_label, occ1950_cat_label,
         ind1950, ind1950_label, ind1950_cat_label) %>%
  
  # Data prepping for combining
  # Do not run below for full unfiltered data set
  filter(labforce == "Yes, in the labor force") %>%
  mutate(race = as.character(race),
         sex = as.character(sex))
```

<br>

#### Loading 1880

```{r message = FALSE, warning = FALSE, eval = FALSE}
# Loading
mn_1880 = readr::read_csv("../Data/census_1880_occ_mn.csv") %>% mutate(city = "Manhattan")
bk_1880 = readr::read_csv("../Data/census_1880_occ_bk.csv") %>% mutate(city = "Brooklyn")
combined_1880 = rbind(mn_1880, bk_1880)

# Saving Memory
rm(bk_1880)
rm(mn_1880)

# Combining Data
combined_1880 = combined_1880 %>% 
  select(age, sex, race, labforce,
         occ, city, occstr, occ1950_label = occ1950, 
         enumdist, ind1950_label = ind1950) %>%
  left_join(OCC_1880, by = c("occ" = "code")) %>%
  mutate(occ_cat_label = add_occ_cat_label(.),
         age = ifelse(age == "Less than 1 year old",
                      0,
                      age),
         age = as.numeric(age),
         year = 1880,
         ward = NA_integer_,
         occ1950 = NA_integer_,
         occ1950_cat_label = NA_character_,
         ind1950 = NA_integer_,
         ind1950_cat_label = NA_character_) %>%
  
  select(year, age, sex, race, city, 
         enumdist, ward, labforce,
         occstr,
         occ, occ_label, occ_cat_label, 
         occ1950, occ1950_label, occ1950_cat_label,
         ind1950, ind1950_label, ind1950_cat_label) %>%
  
  # Data prepping for combining
  filter(labforce == "Yes, in the labor force")
```

<br>

#### Loading 1910

```{r message = FALSE, warning = FALSE, eval = FALSE}
# Loading
mn_1910 = readr::read_csv("../Data/census_1910_occ_mn.csv") %>% mutate(city = "Manhattan")
bk_1910 = readr::read_csv("../Data/census_1910_occ_bk.csv") %>% mutate(city = "Brooklyn")
OCC_1950 = readr::read_csv("../Data/OCC1950.csv")
combined_1910 = rbind(mn_1910, bk_1910)

# Saving Memory
rm(bk_1910)
rm(mn_1910)

# Combining Data
combined_1910 = combined_1910 %>%
  left_join(OCC_1950, by = c("occ1950" = "code")) %>%
  select(age, sex, labor_force, race, 
         occ1950, occstr, occ1950_label, city,
         enumdist, ind1950 = ind_1950) %>%
  left_join(IND_1950, by = "ind1950") %>%
  mutate(occ = occ1950,
         occ_label = occ1950_label,
         ward = NA_integer_) %>%
  mutate(occ1950_cat_label = add_occ1950_cat_label(.),
         occ_cat_label = occ1950_cat_label,
         ind1950_cat_label = add_ind1950_cat_label(.),
         sex = factor(sex,
                      levels = c(1,2),
                      labels = c("Male", "Female")),
         labor_force = factor(labor_force,
                              levels = c(0,1,2),
                              labels = c("N/A", 
                                         "No, not in the labor force",
                                         "Yes, in the labor force")),
         race = factor(race,
                       levels = c(100, 140, 200, 210, 300, 400, 500, 600, 672),
                       labels = c("White", "Mexican (1930)", 
                                  "Black/African American/Negro",
                                  "Mulatto", 
                                  "American Indian/Alaska Native (AIAN)",
                                  "Chinese",
                                  "Japanese",
                                  "Filipino",
                                  "Asian, not specified")),
         year = 1910) %>%
  
  select(year, age, sex, race, city, 
         enumdist, ward, labforce = labor_force,
         occstr,
         occ, occ_label, occ_cat_label, 
         occ1950, occ1950_label, occ1950_cat_label,
         ind1950, ind1950_label, ind1950_cat_label) %>%
  
  # Data prepping for combining
  filter(labforce == "Yes, in the labor force") %>%
  mutate(occ1950_label = occ_label,
         sex = as.character(sex),
         race = as.character(race),
         enumdist = as.numeric(enumdist))
```

<br>

#### Combining all time periods, applying `occ_modifier`

```{r eval = FALSE}
combined = 
  bind_rows(combined, 
            combined_1880, 
            combined_1910) %>%
  mutate(occstr_mod = occ_modifier(occstr)) %>%
  
  select(year, age, sex, race, city, 
         enumdist, ward,
         occstr, occstr_mod,
         occ, occ_label, occ_cat_label, 
         occ1950, occ1950_label, occ1950_cat_label,
         ind1950, ind1950_label, ind1950_cat_label)
```

```{r eval = FALSE}
rm(combined)
rm(combined_1880)
rm(combined_1910)
```

```{r eval = FALSE}
sub = combined %>% filter(year == 1880)

sub = sub %>% 
  select(-occ1950, -ind1950) %>%
  left_join(OCC_1950) %>% 
  select(occ1950 = code, everything()) %>%
  mutate(occ1950_cat_label = add_occ1950_cat_label(.)) %>%
  left_join(IND_1950) %>%
  mutate(ind1950_cat_label = add_ind1950_cat_label(.)) %>%
  select(year, age, sex, race, city, 
         enumdist, ward,
         occstr, occstr_mod,
         occ, occ_label, occ_cat_label, 
         occ1950, occ1950_label, occ1950_cat_label,
         ind1950, ind1950_label, ind1950_cat_label)

combined = combined %>% 
  filter(year == 1850 | year == 1910) %>%
  rbind(sub)
```


```{r eval = FALSE}
readr::write_csv(combined, "combined.csv")
```

```{r warning = FALSE}
combined = readr::read_csv("../Data/combined.csv") %>%
  mutate(year     = as.factor(year),
         sex      = as.factor(sex),
         race     = as.factor(race),
         city     = as.factor(city))

# To reduce computation later
var_lf_1850 = combined %>% filter(year == 1850) %>% NROW()
var_lf_1880 = combined %>% filter(year == 1880) %>% NROW()
var_lf_1910 = combined %>% filter(year == 1910) %>% NROW()
var_lf = var_lf_1850 + var_lf_1880 + var_lf_1910
```

<br>

#### shp Files

```{r}
top_n_occupations = function(n, year_in = "all") {
  
  if (year_in == "all") {
    
    return(
      combined %>%
        filter(occ1950_label != "Not yet classified") %>%
        group_by(occ1950_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$occ1950_label
    ) 
  } else if (year_in %in% c("1850", "1880", "1910")) {
    
    return (
      combined %>%
        filter(year == year_in & occ1950_label != "Not yet classified") %>%
        group_by(occ1950_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$occ1950_label
    )
  }
}

top_n_occupation_cat = function(n, year_in = "all") {
  
  if (year_in == "all") {
    
    return(
      combined %>%
        filter(occ1950_cat_label != "Not yet classified") %>%
        group_by(occ1950_cat_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$occ1950_cat_label
    ) 
  } else if (year_in %in% c("1850", "1880", "1910")) {
    
    return (
      combined %>%
        filter(year == year_in & occ1950_cat_label != "Not yet classified") %>%
        group_by(occ1950_cat_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$occ1950_cat_label
    )
  }
}

top_n_industry = function(n, year_in = "all") {
  
  if (year_in == "all") {
    
    return(
      combined %>%
        filter(ind1950_label != "Not yet classified") %>%
        group_by(ind1950_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$ind1950_label
    ) 
  } else if (year_in %in% c("1850", "1880", "1910")) {
    
    return (
      combined %>%
        filter(year == year_in & ind1950_label != "Not yet classified") %>%
        group_by(ind1950_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$ind1950_label
    )
  }
}

top_n_industry_cat = function(n, year_in = "all") {
  
  if (year_in == "all") {
    
    return(
      combined %>%
        filter(ind1950_cat_label != "Not yet classified") %>%
        group_by(ind1950_cat_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$ind1950_cat_label
    ) 
  } else if (year_in %in% c("1850", "1880", "1910")) {
    
    return (
      combined %>%
        filter(year == year_in & ind1950_cat_label != "Not yet classified") %>%
        group_by(ind1950_cat_label) %>%
        summarise(count = n()) %>%
        arrange(desc(count)) %>%
        head(n) %>%
        .$ind1950_cat_label
    )
  }
}
```

```{r}
bk_1850 = st_read("../Data/shpfiles/bk_shapefiles/Ward_1850_BK.shp",
                  stringsAsFactors = FALSE) %>%
  select(Ward_Num, geometry)
mn_1850 = st_read("../Data/shpfiles/mn_shapefiles/Ward_1850_MN.shp",
                  stringsAsFactors = FALSE) %>%
  select(Ward_Num, geometry)

shp_1850 = rbind(bk_1850, mn_1850) %>%
  st_transform(crs = 4326)

rm(bk_1850)
rm(mn_1850)
```

```{r}
bk_1880 = st_read("../Data/shpfiles/bk_shapefiles/ED_1880_S4_BK.shp",
                  stringsAsFactors = FALSE) %>% 
  select(ED, geometry)
mn_1880 = st_read("../Data/shpfiles/mn_shapefiles/ED_1880_MN.shp",
                  stringsAsFactors = FALSE) %>%
  select(ED = ed80, geometry)

shp_1880 = rbind(bk_1880, mn_1880) %>%
  st_transform(crs = 4326)

rm(bk_1880)
rm(mn_1880)
```


```{r}
bk_1910 = st_read("../Data/shpfiles/bk_shapefiles/Brooklyn_1910.shp",
                  stringsAsFactors = FALSE)
mn_1910 = st_read("../Data/shpfiles/mn_shapefiles/Manhattan_1910.shp",
                  stringsAsFactors = FALSE)

shp_1910 = rbind(bk_1910, mn_1910) %>%
  mutate(ED = as.numeric(ED)) %>%
  st_transform(crs = 4326)

rm(bk_1910)
rm(mn_1910)
```


### 2. Analysis of Demographics {.tabset .tabset-fade}

#### Age

##### General Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 5, 
                 fill     = "#FBD75C", 
                 col      = "#FFA600") +
  scale_x_continuous(limits = c(0, 100),
                     breaks = seq(0, 100, 10)) + 
  labs(y = "Count", x = "Age",
       title = "Histogram of Age of the Labor Force")

describe(combined$age)
```

<br>

##### Yearly Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
col_3 = c("#ffa600", "#bc5090", "#003f5c")

combined %>%
  ggplot(aes(x = age, fill = year)) +
  geom_histogram(binwidth = 5) +
  facet_wrap(~year) +
  scale_fill_manual(values = col_3) +
  labs(y = "Count", x = "Age",
       title = "Histogram of Age of Labor Force across Time Periods") + 
  theme(legend.position = "none")

combined %>%
  select(age, year) %>%
  describeBy(group = .$year)
```

<br>

#### Sex

##### General Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
col_2 = c("#FF5959", "#003A6F")

combined %>%
  group_by(year, sex) %>%
  summarise(count = n()) %>%
  
  ggplot(aes(y = count, x = sex, fill = sex)) +
  geom_col() + 
  geom_text(aes(label = count),
            family = "Quicksand",
            vjust = -0.5) +
  facet_wrap(~year) +
  scale_fill_manual(values = col_2) +
  labs(y = "Count", x = "Sex",
       title = "Graph of Sex of Labor Force across Time Periods") +
  theme(legend.position = "none") 
```

<br>

##### Percent of Labor Force

```{r}
combined %>%
  group_by(year, sex) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count, x = sex, fill = sex)) +
  geom_col() + 
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            vjust = -0.5) +
  facet_wrap(~year) +
  scale_fill_manual(values = col_2) +
  labs(y = "Count", x = "Sex",
       title = "Graph of Sex of Percentage of Labor Force across Time Periods") +
  theme(legend.position = "none") 
```

<br>

#### Race

##### General Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, race) %>%
  summarise(count = n()) %>%
  
  ggplot(aes(y = count, x = race, fill = race)) +
  geom_col() + 
  geom_text(aes(label = count),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  coord_flip() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  labs(y = "Count", x = "Race",
       title = "Graph of Race of Labor Force across Time Periods") +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 7))
```

<br>

##### Percent of Labor Force

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, race) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count, x = race, fill = race)) +
  geom_col() + 
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  coord_flip() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  labs(y = "Count", x = "Race",
       title = "Graph of Percentage of Race of Labor Force across Time Periods") +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 7))
```

<br>

#### City

##### General Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, city) %>%
  summarise(count = n()) %>%
  
  ggplot(aes(y = count, x = city, fill = city)) +
  geom_col() + 
  geom_text(aes(label = count),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year) +
  coord_flip() +
  scale_fill_manual(values = col_2) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  labs(y = "Count", x = "Borough",
       title = "Graph of Borough of Labor Force across Time Periods") +
  theme(legend.position = "none")
```

<br>

##### Percent of Labor Force

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, city) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count, x = city, fill = city)) +
  geom_col() + 
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year) +
  coord_flip() +
  scale_fill_manual(values = col_2) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  labs(y = "Count", x = "Borough",
       title = "Graph of Percent of Borough of Labor Force across Time Periods") +
  theme(legend.position = "none")
```

<br>

### 3. Top 10s Analysis {.tabset .tabset-fade}

#### Occupation {.tabset .tabset-fade}

##### Datatable of General Counts {.tabset .tabset-fade}

###### Overall 

```{r}
combined %>%
  group_by(occ1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```

* Across years, Operative and kindred workers (n.e.c.), Managers, officials, and proprietors (n.e.c.), Private household workers (n.e.c.) and Laborers (n.e.c.) appear to be the occupations which consistently are the most common

<br>

###### 1850 

```{r}
combined %>%
  filter(year == 1850) %>%
  group_by(occ1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf_1850 * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```
<br>

###### 1880 

```{r}
combined %>%
  filter(year == 1880) %>%
  group_by(occ1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf_1880 * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```
<br>

###### 1910 

```{r}
combined %>%
  filter(year == 1910) %>%
  group_by(occ1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf_1910 * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```
<br>

##### Graph of General Counts {.tabset .tabset-fade}

###### General Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, occ1950_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(occ1950_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = count),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Occupation",
       title = "Graph of Most Popular Occupations across Time Periods") +
  theme(legend.position = "none")
```

<br>

###### Percent of Labor Force

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, occ1950_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(occ1950_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Occupation",
       title = "Graph of Most Popular Occupations across Time Periods as Percentage of Labor Force") +
  theme(legend.position = "none")
```

<br>

#### Occupation Categories {.tabset .tabset-fade}

##### Datatable of General Counts {.tabset .tabset-fade}

###### Overall 

```{r}
combined %>%
  group_by(occ1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```

* Across years, Operative and kindred workers (n.e.c.), Managers, officials, and proprietors (n.e.c.), Private household workers (n.e.c.) and Laborers (n.e.c.) appear to be the occupations which consistently are the most common

<br>

###### 1850 

```{r}
combined %>%
  filter(year == 1850) %>%
  group_by(occ1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf_1850 * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```
<br>

###### 1880 

```{r}
combined %>%
  filter(year == 1880) %>%
  group_by(occ1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf_1880 * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```
<br>

###### 1910 

```{r}
combined %>%
  filter(year == 1910) %>%
  group_by(occ1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf_1910 * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```
<br>

##### Graph of General Counts {.tabset .tabset-fade}

###### General Trends

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, occ1950_cat_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(occ1950_cat_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = count),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Occupation",
       title = "Graph of Most Popular Occupation Categories across Time Periods") +
  theme(legend.position = "none")
```

<br>

###### Percent of Labor Force

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, occ1950_cat_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(occ1950_cat_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Occupation",
       title = "Graph of Most Popular Occupation Categories across Time Periods as Percentage of Labor Force") +
  theme(legend.position = "none")
```

<br>

#### Industry {.tabset .tabset-fade}

##### Datatable of General Counts {.tabset .tabset-fade}

###### Overall

```{r}
combined %>%
  group_by(ind1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```

<br>

###### 1850 

```{r}
combined %>%
  filter(year == 1850) %>%
  group_by(ind1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  datatable()
```

<br>

###### 1880 

```{r}
combined %>%
  filter(year == 1880) %>%
  group_by(ind1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  datatable()
```

<br>

###### 1910 

```{r}
combined %>%
  filter(year == 1910) %>%
  group_by(ind1950_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  datatable()
```

<br>

##### Graph of General Counts {.tabset .tabset-fade}

###### General Trends

```{r}
combined %>%
  group_by(year, ind1950_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(ind1950_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = count),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Industry",
       title = "Graph of Most Popular Industries across Time Periods") +
  theme(legend.position = "none")
```

###### Percent of Labor Force

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, ind1950_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(ind1950_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Industry",
       title = "Graph of Most Popular Industries across Time Periods as Percentage of Labor Force") +
  theme(legend.position = "none")
```

<br>

#### Industry Categories {.tabset .tabset-fade}

##### Datatable of General Counts {.tabset .tabset-fade}

###### Overall

```{r}
combined %>%
  group_by(ind1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  head(200) %>% # Datatable can only handle a limited amount of data
  datatable()
```

<br>

###### 1850 

```{r}
combined %>%
  filter(year == 1850) %>%
  group_by(ind1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  datatable()
```

<br>

###### 1880 

```{r}
combined %>%
  filter(year == 1880) %>%
  group_by(ind1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  datatable()
```

<br>

###### 1910 

```{r}
combined %>%
  filter(year == 1910) %>%
  group_by(ind1950_cat_label) %>%
  summarise(count = n()) %>%
  mutate(perc = round(count / var_lf * 100,
                      digits = 2)) %>%
  arrange(desc(count)) %>%
  datatable()
```

<br>

##### Graph of General Counts {.tabset .tabset-fade}

###### General Trends

```{r}
combined %>%
  group_by(year, ind1950_cat_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(ind1950_cat_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = count),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Industry",
       title = "Graph of Most Popular Industry Categories across Time Periods") +
  theme(legend.position = "none")
```

###### Percent of Labor Force

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(year, ind1950_cat_label) %>%
  summarise(count = n()) %>%
  group_by(year) %>%
  top_n(10, wt = count) %>%
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850,
    year == 1880 ~ count / var_lf_1880,
    year == 1910 ~ count / var_lf_1910),
    count = round(count * 100,
                  digits = 1)) %>%
  
  ggplot(aes(y = count,
             x = reorder_within(ind1950_cat_label, count, year),
             fill = year)) +
  geom_col() +
  geom_text(aes(label = paste0(count, "%")),
            family = "Quicksand",
            hjust = 0) +
  facet_wrap(~year, scales = "free_x") +
  scale_x_reordered() +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.5))) +
  scale_fill_manual(values = col_3) +
  coord_flip() +
  labs(y = "Count", x = "Industry",
       title = "Graph of Most Popular Industry Categories across Time Periods as Percentage of Labor Force") +
  theme(legend.position = "none")
```

<br>

### 4. Maps of Counts {.tabset .tabset-fade}

#### 1850 {.tabset .tabset-fade}

##### Leaflet Map of Counts

```{r}

```

##### Distributions of Occupation

__Occupation__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1850 & 
           occ1950_label %in% top_n_occupations(10, 1850)) %>%
  group_by(occ1950_label, ward) %>%
  summarise(count = n()) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised by size of each ward__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(ward) %>%
  mutate(ward_size = n()) %>%
  filter(occ1950_label %in% top_n_occupations(10, 1850)) %>%
  group_by(occ1950_label, ward, ward_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / ward_size * 100) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1850 & 
           occ1950_label %in% top_n_occupations(10, 1850)) %>%
  group_by(occ1950_label, ward) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    count <=  500 ~ 1,
    count <= 1000 ~ 2,
    count <= 1500 ~ 3,
    count <= 2000 ~ 4,
    count <= Inf ~ 5
  ),
         count = factor(count,
                        levels = 1:5,
                        labels = c("   0 -  500", "501 - 1000",
                                   "1001 - 1500", "1501 - 2000",
                                   "2001 -  Inf"))) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised and grouped by size of each ward__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(ward) %>%
  mutate(ward_size = n()) %>%
  filter(occ1950_label %in% top_n_occupations(10, 1850)) %>%
  group_by(occ1950_label, ward, ward_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / ward_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 20 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 - 5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

##### Distributions of Race

__Race__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(race, ward) %>%
  summarise(count = n()) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised by size of each ward__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(ward) %>%
  mutate(ward_size = n()) %>%
  group_by(race, ward, ward_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / ward_size * 100) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(race, ward) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    count <= 5000 ~ 1,
    count <= 7500 ~ 2,
    count <= 10000 ~ 3,
    count <= 12500 ~ 4,
    count <= Inf ~ 5
  ),
         count = factor(count,
                        levels = 1:5,
                        labels = c("    0 -  5000", " 5001 -  7500",
                                   " 7501 - 10000", "10001 - 12500",
                                   "12501 -   Inf"))) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised and grouped by size of each ward__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  group_by(ward) %>%
  mutate(ward_size = n()) %>%
  group_by(race, ward, ward_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / ward_size * 100,
         count = case_when(
           count <= 80 ~ 1,
           count <= 85 ~ 2,
           count <= 90 ~ 3,
           count <= 95 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 - 80", " 81 - 85",
                                   "86 - 90", "91 - 95",
                                   "96 - 100"))) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

#### 1880 {.tabset .tabset-fade}

##### Leaflet Map of Counts

##### Distributions of Occupation

<br>

__Occupation__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1880 & 
           occ1950_label %in% top_n_occupations(10, 1880)) %>%
  group_by(occ1950_label, enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1880) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label %in% top_n_occupations(10, 1880)) %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1880 & 
           occ1950_label %in% top_n_occupations(10, 1880)) %>%
  group_by(occ1950_label, enumdist) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    count <= 100 ~ 1,
    count <= 200 ~ 2,
    count <= 300 ~ 3,
    count <= 400 ~ 4,
    count <= Inf ~ 5
  ),
         count = factor(count,
                        levels = 1:5,
                        labels = c("  0 - 100", "101 - 200",
                                   "201 - 300", "301 - 400",
                                   "401 - Inf"))) %>%
  
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) +
  scale_fill_viridis_d() +
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped and Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1880) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label %in% top_n_occupations(10, 1880)) %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
    count <= 15 ~ 1,
    count <= 30 ~ 2,
    count <= 45 ~ 3,
    count <= 60 ~ 4,
    count <= 100 ~ 5
  ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 - 15", "16 - 30",
                                   "31 - 45", "46 - 60",
                                   "61 - 100"))) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

##### Distributions of Race

<br>

__Race__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1880) %>%
  group_by(race, enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count), 
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1880) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  group_by(race, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1880) %>%
  group_by(race, enumdist) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    count <= 500 ~ 1,
    count <= 1000 ~ 2,
    count <= 1500 ~ 3,
    count <= 2000 ~ 4,
    count <= Inf ~ 5
  ),
  count = factor(count,
                 levels = 1:5,
                 labels = c("   0 -  500", " 501 - 1000",
                            "1001 - 1500", "1501 - 2000",
                            "2001 -  Inf"))) %>%
  
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count), 
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped and Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1880) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  group_by(race, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
           count <= 20 ~ 1,
           count <= 40 ~ 2,
           count <= 60 ~ 3,
           count <= 80 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 - 20", "21 - 40",
                                   "41 - 60", "61 - 80",
                                   "81 - 100"))) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```
<br>


#### 1910 {.tabset .tabset-fade}

##### Leaflet Map of Counts

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
sub = combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  summarise(count = n()) %>% 
  left_join(shp_1910, ., by = c("ED" = "enumdist"))

bins <- c(0, 500, 1000, 1500, 2000, 2500, 3000)
pal <- colorBin("YlOrRd", 
                domain = sub$count, 
                bins = bins)

label = paste("<b>Count:</b>", sub$count) %>% 
  lapply(htmltools::HTML)

sub %>%
  leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  setView(lat = 40.7128, lng = -73.9500, zoom = 11) %>%
  addPolygons(fillColor = ~pal(count),
              fillOpacity = 0.7,
              weight = 0.25,
              color = "black",
              label = label) %>%
  addLegend(pal = pal,
            values = ~count,
            position = "bottomright")
  
```

<br>

##### Distributions of Occupation

<br>

__Occupation__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1910 & 
           occ1950_label %in% top_n_occupations(10, 1910)) %>%
  group_by(occ1950_label, enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label %in% top_n_occupations(10, 1910)) %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1910 & 
           occ1950_label %in% top_n_occupations(10, 1910)) %>%
  group_by(occ1950_label, enumdist) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    count <= 100 ~ 1,
    count <= 200 ~ 2,
    count <= 300 ~ 3,
    count <= 400 ~ 4,
    count <= Inf ~ 5
  ),
         count = factor(count,
                        levels = 1:5,
                        labels = c("  0 - 100", "101 - 200",
                                   "201 - 300", "301 - 400",
                                   "401 - Inf"))) %>%
  
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) +
  scale_fill_viridis_d() +
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped and Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 8, fig.height = 8}
combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label %in% top_n_occupations(10, 1910)) %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
    count <= 20 ~ 1,
    count <= 40 ~ 2,
    count <= 60 ~ 3,
    count <= 80 ~ 4,
    count <= 100 ~ 5
  ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 - 20", "21 - 40",
                                   "41 - 60", "61 - 80",
                                   "81 - 100"))) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(occ1950_label)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~occ1950_label, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

##### Distributions of Race

<br>

__Race__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1910) %>%
  group_by(race, enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count), 
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  group_by(race, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6, cahe = TRUE}
combined %>%
  filter(year == 1910) %>%
  group_by(race, enumdist) %>%
  summarise(count = n()) %>%
  mutate(count = case_when(
    count <= 500 ~ 1,
    count <= 1000 ~ 2,
    count <= 1500 ~ 3,
    count <= 2000 ~ 4,
    count <= Inf ~ 5
  ),
  count = factor(count,
                 levels = 1:5,
                 labels = c("   0 -  500", " 501 - 1000",
                            "1001 - 1500", "1501 - 2000",
                            "2001 -  Inf"))) %>%
  
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count), 
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```

<br>

__Grouped and Normalised by size of each enumeration district__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  group_by(race, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
           count <= 20 ~ 1,
           count <= 40 ~ 2,
           count <= 60 ~ 3,
           count <= 80 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 - 20", "21 - 40",
                                   "41 - 60", "61 - 80",
                                   "81 - 100"))) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  filter(!is.na(race)) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  facet_wrap(~race, nrow = 2) + 
  scale_fill_viridis_d() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())
```
<br>

### 5. Analysis of Changing Trends {.tabset .tabset-fade}

#### OCC {.tabset .tabset-fade}

##### Graph of Top 10 Occupations

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
top_10_occ_combined = c(top_n_occupations(10, 1850),
                        top_n_occupations(10, 1880),
                        top_n_occupations(10, 1910)) %>%
  unique()
top_10_occ_combined = 
  data.frame(year = rep(c(1850, 1880, 1910), 
                        each = length(top_10_occ_combined)),
             occ1950_label = rep(top_10_occ_combined, 3),
             stringsAsFactors = FALSE)

top_10_occ_combined = top_10_occ_combined %>%
  mutate(top = case_when(
    year == 1850 & occ1950_label %in% top_n_occupations(10, 1850) ~ 1,
    year == 1880 & occ1950_label %in% top_n_occupations(10, 1880) ~ 1,
    year == 1910 & occ1950_label %in% top_n_occupations(10, 1910) ~ 1,
    TRUE ~ 0
  ))

combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(occ1950_label %in% top_10_occ_combined$occ1950_label) %>%
  group_by(year, occ1950_label) %>%
  summarise(count = n()) %>%
  
  left_join(top_10_occ_combined, ., 
            by = c("year", "occ1950_label")) %>%
  
  group_by(occ1950_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(occ1950_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Occupations", col = "Year", x = "Count",
       title = "Graph of Occupation Counts in Top 10 Occupations from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the occupation was a top 10 occupation in that time\nperiod. Occupations areordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

##### Graph of Top 10 Occupations, Normalised

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(occ1950_label %in% top_10_occ_combined$occ1950_label) %>%
  group_by(year, occ1950_label) %>%
  summarise(count = n()) %>%
  
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850 * 100,
    year == 1880 ~ count / var_lf_1880 * 100,
    year == 1910 ~ count / var_lf_1910 * 100
  )) %>%
  
  left_join(top_10_occ_combined, ., 
            by = c("year", "occ1950_label")) %>%
  
  group_by(occ1950_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(occ1950_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Occupations", col = "Year", x = "Count",
       title = "Graph of Occupation Counts in Top 10 Occupations from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the occupation was a top 10 occupation in that time\nperiod. Occupations areordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

##### Maps of Top Occupation {.tabset .tabset-fade}

###### Operative and kindred workers (n.e.c.) 

__Operative and kindred workers (n.e.c.)__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
tmp_map_1850 = combined %>%
  filter(year == 1850,
         occ1950_label == "Operative and kindred workers (n.e.c.)") %>%
  group_by(ward) %>%
  summarise(count = n()) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1880 = combined %>%
  filter(year == 1880,
         occ1950_label == "Operative and kindred workers (n.e.c.)") %>%
  group_by(enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1910 = combined %>%
  filter(year == 1910,
         occ1950_label == "Operative and kindred workers (n.e.c.)") %>%
  group_by(enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

ggarrange(tmp_map_1850, tmp_map_1880, tmp_map_1910,
          labels = c("1850", "1880", "1910"),
          nrow = 1,
          font.label = list(size = 12, face = "plain", family = "Quicksand"))
```

<br>

__Operative and kindred workers (n.e.c.) Normalised__

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
tmp_map_1850 = combined %>%
  group_by(ward) %>%
  mutate(ward_size = n()) %>%
  filter(year == 1850,
         occ1950_label == "Operative and kindred workers (n.e.c.)") %>%
  group_by(ward, ward_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / ward_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 20 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 -  5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_d(drop = FALSE) + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1880 = combined %>%
  filter(year == 1880) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label == "Operative and kindred workers (n.e.c.)") %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 25 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 -  5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_d(drop = FALSE) + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1910 = combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label == "Operative and kindred workers (n.e.c.)") %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 20 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 -  5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_d(drop = FALSE) + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

ggarrange(tmp_map_1850, tmp_map_1880, tmp_map_1910,
          labels = c("1850", "1880", "1910"),
          nrow = 1,
          font.label = list(size = 12, face = "plain", family = "Quicksand"))
```

<br>

###### Managers, officials, and proprietors (n.e.c.) (n.e.c.) 

__Managers, officials, and proprietors (n.e.c.)__

```{r}
tmp_map_1850 = combined %>%
  filter(year == 1850,
         occ1950_label == "Managers, officials, and proprietors (n.e.c.)") %>%
  group_by(ward) %>%
  summarise(count = n()) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1880 = combined %>%
  filter(year == 1880,
         occ1950_label == "Managers, officials, and proprietors (n.e.c.)") %>%
  group_by(enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1910 = combined %>%
  filter(year == 1910,
         occ1950_label == "Managers, officials, and proprietors (n.e.c.)") %>%
  group_by(enumdist) %>%
  summarise(count = n()) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_c() + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

ggarrange(tmp_map_1850, tmp_map_1880, tmp_map_1910,
          labels = c("1850", "1880", "1910"),
          nrow = 1,
          font.label = list(size = 12, face = "plain", family = "Quicksand"))
```

<br>

__Managers, officials, and proprietors (n.e.c.) Normalised__

```{r}
tmp_map_1850 = combined %>%
  group_by(ward) %>%
  mutate(ward_size = n()) %>%
  filter(year == 1850,
         occ1950_label == "Managers, officials, and proprietors (n.e.c.)") %>%
  group_by(ward, ward_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / ward_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 20 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 -  5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1850, ., by = c("Ward_Num" = "ward")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_d(drop = FALSE) + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1880 = combined %>%
  filter(year == 1880) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label == "Managers, officials, and proprietors (n.e.c.)") %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 25 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 -  5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1880, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_d(drop = FALSE) + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

tmp_map_1910 = combined %>%
  filter(year == 1910) %>%
  group_by(enumdist) %>%
  mutate(enum_size = n()) %>%
  filter(occ1950_label == "Managers, officials, and proprietors (n.e.c.)") %>%
  group_by(occ1950_label, enumdist, enum_size) %>%
  summarise(count = n()) %>%
  mutate(count = count / enum_size * 100,
         count = case_when(
           count <= 5 ~ 1,
           count <= 10 ~ 2,
           count <= 15 ~ 3,
           count <= 20 ~ 4,
           count <= 100 ~ 5
         ),
         count = factor(count,
                        levels = 1:5,
                        labels = c(" 0 -  5", " 6 - 10",
                                   "11 - 15", "16 - 20",
                                   "21 - 100"))) %>%
  left_join(shp_1910, ., by = c("ED" = "enumdist")) %>%
  
  ggplot() +
  geom_sf(aes(fill = count),
          colour = "black",
          size = 0.25) +
  scale_fill_viridis_d(drop = FALSE) + 
  labs(fill = "Count") +
  theme(legend.position = "right",
        axis.text = element_blank(),
        strip.text.x = element_text(size = 7),
        legend.key.height = unit(2,"line"),
        legend.key.width = unit(1,"line"),
        panel.grid = element_blank())

ggarrange(tmp_map_1850, tmp_map_1880, tmp_map_1910,
          labels = c("1850", "1880", "1910"),
          nrow = 1,
          font.label = list(size = 12, face = "plain", family = "Quicksand"))
```

<br>

#### Occ Categories {.tabset .tabset-fade}

##### Graph of Top 10 Occupation Categories

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
top_10_occ_cat_combined = c(top_n_occupation_cat(10, 1850),
                            top_n_occupation_cat(10, 1880),
                            top_n_occupation_cat(10, 1910)) %>%
  unique()
top_10_occ_cat_combined = 
  data.frame(year = rep(c(1850, 1880, 1910), 
                        each = length(top_10_occ_cat_combined)),
             occ1950_cat_label = rep(top_10_occ_cat_combined, 3),
             stringsAsFactors = FALSE)

top_10_occ_cat_combined = top_10_occ_cat_combined %>%
  mutate(top = case_when(
    year == 1850 & occ1950_cat_label %in% top_n_occupation_cat(10, 1850) ~ 1,
    year == 1880 & occ1950_cat_label %in% top_n_occupation_cat(10, 1880) ~ 1,
    year == 1910 & occ1950_cat_label %in% top_n_occupation_cat(10, 1910) ~ 1,
    TRUE ~ 0
  ))

combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(occ1950_cat_label %in% top_10_occ_cat_combined$occ1950_cat_label) %>%
  group_by(year, occ1950_cat_label) %>%
  summarise(count = n()) %>%
  
  left_join(top_10_occ_cat_combined, ., 
            by = c("year", "occ1950_cat_label")) %>%
  
  group_by(occ1950_cat_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(occ1950_cat_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Occupations", col = "Year", x = "Count",
       title = "Graph of Occupation Counts in Top 10 Occupations from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the category was a top 10 category in that time\nperiod. Categories are ordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

##### Graph of Top 10 Occupation Categories, Normalised

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(occ1950_cat_label %in% top_10_occ_cat_combined$occ1950_cat_label) %>%
  group_by(year, occ1950_cat_label) %>%
  summarise(count = n()) %>%
  
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850 * 100,
    year == 1880 ~ count / var_lf_1880 * 100,
    year == 1910 ~ count / var_lf_1910 * 100
  )) %>%
  
  left_join(top_10_occ_cat_combined, ., 
            by = c("year", "occ1950_cat_label")) %>%
  
  group_by(occ1950_cat_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(occ1950_cat_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Occupations", col = "Year", x = "Count",
       title = "Graph of Occupation Counts in Top 10 Occupation Categories from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the category was a top 10 category in that time\nperiod. Categories are ordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

#### Industry {.tabset .tabset-fade}

##### Graph of Top 10 Industries

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
top_10_ind_combined = c(top_n_industry(10, 1850),
                        top_n_industry(10, 1880),
                        top_n_industry(10, 1910)) %>%
  unique()
top_10_ind_combined = 
  data.frame(year = rep(c(1850, 1880, 1910), 
                        each = length(top_10_ind_combined)),
             ind1950_label = rep(top_10_ind_combined, 3),
             stringsAsFactors = FALSE)

top_10_ind_combined = top_10_ind_combined %>%
  mutate(top = case_when(
    year == 1850 & ind1950_label %in% top_n_industry(10, 1850) ~ 1,
    year == 1880 & ind1950_label %in% top_n_industry(10, 1880) ~ 1,
    year == 1910 & ind1950_label %in% top_n_industry(10, 1910) ~ 1,
    TRUE ~ 0
  ))

combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(ind1950_label %in% top_10_ind_combined$ind1950_label) %>%
  group_by(year, ind1950_label) %>%
  summarise(count = n()) %>%
  
  left_join(top_10_ind_combined, ., 
            by = c("year", "ind1950_label")) %>%
  
  group_by(ind1950_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(ind1950_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Industry", col = "Year", x = "Count",
       title = "Graph of Industry Counts in Top 10 Industry from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the category was a top 10 industry in that time\nperiod. Industries are ordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

##### Graph of Top 10 Industries, Normalised

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(ind1950_label %in% top_10_ind_combined$ind1950_label) %>%
  group_by(year, ind1950_label) %>%
  summarise(count = n()) %>%
  
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850 * 100,
    year == 1880 ~ count / var_lf_1880 * 100,
    year == 1910 ~ count / var_lf_1910 * 100
  )) %>%
  
  left_join(top_10_ind_combined, ., 
            by = c("year", "ind1950_label")) %>%
  
  group_by(ind1950_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(ind1950_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Occupations", col = "Year", x = "Count",
       title = "Graph of Industry Counts in Top 10 Industries from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the industry was a top 10 industry in that time\nperiod. Industries are ordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

#### Industry Categories {.tabset .tabset-fade}

##### Graph of Top 10 Industries Categories

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
top_10_ind_cat_combined = c(top_n_industry_cat(10, 1850),
                        top_n_industry_cat(10, 1880),
                        top_n_industry_cat(10, 1910)) %>%
  unique()
top_10_ind_cat_combined = 
  data.frame(year = rep(c(1850, 1880, 1910), 
                        each = length(top_10_ind_cat_combined)),
             ind1950_cat_label = rep(top_10_ind_cat_combined, 3),
             stringsAsFactors = FALSE)

top_10_ind_cat_combined = top_10_ind_cat_combined %>%
  mutate(top = case_when(
    year == 1850 & ind1950_cat_label %in% top_n_industry_cat(10, 1850) ~ 1,
    year == 1880 & ind1950_cat_label %in% top_n_industry_cat(10, 1880) ~ 1,
    year == 1910 & ind1950_cat_label %in% top_n_industry_cat(10, 1910) ~ 1,
    TRUE ~ 0
  ))

combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(ind1950_cat_label %in% top_10_ind_cat_combined$ind1950_cat_label) %>%
  group_by(year, ind1950_cat_label) %>%
  summarise(count = n()) %>%
  
  left_join(top_10_ind_cat_combined, ., 
            by = c("year", "ind1950_cat_label")) %>%
  
  group_by(ind1950_cat_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(ind1950_cat_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Industry", col = "Year", x = "Count",
       title = "Graph of Industry Category Counts in Top 10 Industry Caetegories from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the category was a top 10 industry in that time\nperiod. Categories are ordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

<br>

##### Graph of Top 10 Occupation Categories, Normalised

```{r message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6}
combined %>% 
  mutate(year = as.numeric(as.character(year))) %>%
  filter(ind1950_cat_label %in% top_10_ind_cat_combined$ind1950_cat_label) %>%
  group_by(year, ind1950_cat_label) %>%
  summarise(count = n()) %>%
  
  mutate(count = case_when(
    year == 1850 ~ count / var_lf_1850 * 100,
    year == 1880 ~ count / var_lf_1880 * 100,
    year == 1910 ~ count / var_lf_1910 * 100
  )) %>%
  
  left_join(top_10_ind_cat_combined, ., 
            by = c("year", "ind1950_cat_label")) %>%
  
  group_by(ind1950_cat_label) %>%
  mutate(difference = first(count) - last(count),
         colour = ifelse(difference > 0,
                         1,
                         0)) %>%
  
  ggplot(aes(y = count, x = year)) +
  geom_col(aes(fill = factor(colour),
               col = factor(top)),
           size = 1) +
  facet_wrap(~reorder(ind1950_cat_label, difference), 
             scales = "free_y") +
  
  scale_x_continuous(breaks = c(1850, 1880, 1910)) +
  scale_fill_manual(values = c("#56c1ab", "#ee4c58")) +
  scale_color_manual(values = c("white", "black")) +
  
  labs(y = "Occupations", col = "Year", x = "Count",
       title = "Graph of Industry Category Counts in Top 10 Industries from 1850, 1880 and 1910",
       caption = "Note: Black borders were if the category was a top 10 category in that time\nperiod. Categories are ordered by the size of change from 1850 to 1910") +
  theme(legend.position = "none")
```

### 6. Heatmaps of Combinations {.tabset .tabset-fade}

#### Occupation

```{r fig.height = 25}
combined %>%
  group_by(occ1950_label, occ1950_cat_label) %>%
  summarise(count = n()) %>%
  
  ggplot(aes(y = occ1950_label, 
             x = occ1950_cat_label,
             fill = count)) +
  geom_tile() +
  scale_fill_viridis_c() + 
  labs(y = "Occupations", x = "Occupation categories",
       title = "Heatmap of Occupation and Occupation Categories") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

<br>

#### Industries

```{r fig.height = 25}
combined %>%
  group_by(ind1950_label, ind1950_cat_label) %>%
  summarise(count = n()) %>%
  
  ggplot(aes(y = ind1950_label, 
             x = ind1950_cat_label,
             fill = count)) +
  geom_tile() +
  scale_fill_viridis_c() + 
  labs(y = "Industries", x = "Industry categories",
       title = "Heatmap of Industry and Industry Categories") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```







